
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Spring Native Workshop</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/claat-public/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14" ga4id=""></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  codelab-ga4id=""
                  id="spring-native-workshop-lab1"
                  title="Spring Native Workshop"
                  environment="web"
                  feedback-link="">
    
      <google-codelab-step label="概述" duration="1">
        <h2 is-upgraded>您將學到什麼</h2>
<p>在本實驗中，您將學習：</p>
<ul>
<li>如何使用 Spring Initializr 建立 Spring Boot 專案</li>
<li>如何配置 Spring Native 相關設定</li>
<li>如何建置 JIT 和 Native 映像檔</li>
<li>如何部署應用程式到 Google Cloud Run</li>
<li>JIT 與 Native 映像檔的效能比較</li>
</ul>
<h2 is-upgraded>先決條件</h2>
<ul>
<li>基本的 Java 和 Spring Boot 知識</li>
<li>已安裝 Docker</li>
<li>已安裝 Google Cloud SDK (gcloud)</li>
<li>已設定好 Google Cloud 專案</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="建立 Spring Boot 專案" duration="1">
        <h2 is-upgraded>建立專案</h2>
<p>我們會從 start.spring.io 取得應用程式：</p>
<pre><code language="language-bash" class="language-bash">curl https://start.spring.io/starter.zip -d dependencies=web \
           -d javaVersion=11 \
           -d bootVersion=3.4.0 -o io-native-starter.zip
</code></pre>
<p>這個指令會下載一個包含 Spring Web 依賴的專案，使用 Java 11 和 Spring Boot 3.4.0 版本。</p>
<h2 is-upgraded>解壓縮專案</h2>
<pre><code language="language-bash" class="language-bash">unzip io-native-starter.zip
</code></pre>
<p>Positive : 專案已成功建立！接下來我們要配置 Spring Native 相關設定。</p>


      </google-codelab-step>
    
      <google-codelab-step label="配置 Gradle 建置檔案" duration="5">
        <h2 is-upgraded>1. 加入 AOT 外掛程式</h2>
<p>在 <code>build.gradle</code> 檔案的 <code>plugins</code> 區塊中加入 Spring AOT (Ahead-of-Time) 編譯外掛程式：</p>
<pre><code language="language-java" class="language-java">plugins {
  id &#39;org.graalvm.buildtools.native&#39; version &#39;0.10.1&#39;
}
</code></pre>
<p><strong>作用：</strong> 這個外掛程式會預先處理您的 Spring 應用程式，分析程式碼並產生原生映像檔所需的設定檔。</p>
<p><strong>目的：</strong> 顯著提升原生映像檔的相容性、啟動速度並減少記憶體佔用。這是建置 Spring Native 應用程式的關鍵步驟。</p>
<h2 is-upgraded>2. 加入 Spring Release 存放區</h2>
<p>在 <code>build.gradle</code> 檔案的 <code>repositories</code> 區塊中加入：</p>
<pre><code language="language-java" class="language-java">repositories {
  mavenCentral()
  maven { url &#39;https://repo.spring.io/release&#39; }
}
</code></pre>
<p><strong>作用：</strong> 告訴 Gradle 一個新的可以下載套件的倉庫地址。</p>
<p><strong>目的：</strong> Spring Native 相關的套件是實驗性功能，它們放在 Spring 自己的 release 倉庫裡。不加上這行，Gradle 會因為找不到 AOT 外掛程式而報錯。</p>
<h2 is-upgraded>3. 配置原生映像檔建置設定</h2>
<p>在 <code>build.gradle</code> 檔案中加入 <code>bootBuildImage</code> 設定：</p>
<pre><code language="language-java" class="language-java">bootBuildImage {
  builder = &#39;paketobuildpacks/builder-jammy-base:latest&#39;
  environment = [&#39;BP_NATIVE_IMAGE&#39;: &#39;true&#39;]
}
</code></pre>
<p><strong>作用：</strong> 這一段是針對 <code>bootBuildImage</code> 這個 Gradle 任務的專門設定。</p>
<p><strong>目的：</strong></p>
<ul>
<li><code>builder = 'paketobuildpacks/builder-jammy-base:latest'</code>: 使用 Paketo Buildpacks 的 jammy-base 建置器來建立 Docker 映像檔。這是一個輕量級的基礎映像檔，可以讓最終產生的 Docker 映像檔體積更小，也更安全。</li>
<li><code>environment = ['BP_NATIVE_IMAGE': 'true']</code>: 設定環境變數告訴 Buildpacks 要建置 Spring Native 原生映像檔，而不是傳統的 JVM 應用程式。</li>
</ul>
<h2 is-upgraded>4. 配置 settings.gradle</h2>
<p>在 <code>settings.gradle</code> 檔案中加入：</p>
<pre><code language="language-java" class="language-java">pluginManagement {
  repositories {
	maven { url &#39;https://repo.spring.io/release&#39; }
	gradlePluginPortal()
  }
}
</code></pre>
<p>Positive : 所有配置都完成了！這些設定共同協作，確保您的 Gradle 專案能夠找到並使用 Spring Native 工具，在建置時觸發 AOT 處理，並最終產生一個最佳化的原生 Docker 映像檔。</p>


      </google-codelab-step>
    
      <google-codelab-step label="建置映像檔" duration="5">
        <h2 is-upgraded>建置 Docker 映像檔</h2>
<p>使用以下指令建置 Docker 映像檔：</p>
<pre><code language="language-bash" class="language-bash">./gradlew bootBuildImage
</code></pre>
<p>這個指令會建置一個包含原生映像檔的 Docker 容器。建置過程可能需要幾分鐘時間。</p>
<h2 is-upgraded>驗證映像檔</h2>
<p>建置完成後，檢查產生的 Docker 映像檔：</p>
<pre><code language="language-bash" class="language-bash">docker images demo
</code></pre>
<p>您應該會看到一個名為 <code>demo</code> 的映像檔，標籤為 <code>0.0.1-SNAPSHOT</code>。</p>
<p>Positive : 恭喜！您已經成功建置了 Spring Native 映像檔。</p>


      </google-codelab-step>
    
      <google-codelab-step label="部署到 Google Cloud Run" duration="5">
        <h2 is-upgraded>設定專案變數</h2>
<p>首先，取得您的 Google Cloud 專案 ID：</p>
<pre><code language="language-bash" class="language-bash">export PROJECT_ID=$(gcloud config list --format &#39;value(core.project)&#39;)
</code></pre>
<h2 is-upgraded>部署 JIT 版本</h2>
<h3 is-upgraded>標記映像檔</h3>
<pre><code language="language-bash" class="language-bash">docker tag demo:0.0.1-SNAPSHOT asia-east1-docker.pkg.dev/$PROJECT_ID/jit-image-docker-repo/jit-image:v1
</code></pre>
<h3 is-upgraded>推送映像檔到 Artifact Registry</h3>
<pre><code language="language-bash" class="language-bash">docker push asia-east1-docker.pkg.dev/$PROJECT_ID/jit-image-docker-repo/jit-image:v1
</code></pre>
<h3 is-upgraded>部署到 Cloud Run</h3>
<pre><code language="language-bash" class="language-bash">gcloud run deploy my-jit-service \
  --image asia-east1-docker.pkg.dev/$PROJECT_ID/jit-image-docker-repo/jit-image:v1 \
  --region asia-east1 \
  --memory=1Gi \
  --allow-unauthenticated
</code></pre>
<h2 is-upgraded>部署 Native 版本</h2>
<h3 is-upgraded>標記映像檔</h3>
<pre><code language="language-bash" class="language-bash">docker tag demo:0.0.1-SNAPSHOT asia-east1-docker.pkg.dev/$PROJECT_ID/native-image-docker-repo/native-image:v1
</code></pre>
<h3 is-upgraded>推送映像檔到 Artifact Registry</h3>
<pre><code language="language-bash" class="language-bash">docker push asia-east1-docker.pkg.dev/$PROJECT_ID/native-image-docker-repo/native-image:v1
</code></pre>
<h3 is-upgraded>部署到 Cloud Run</h3>
<pre><code language="language-bash" class="language-bash">gcloud run deploy my-native-service \
  --image asia-east1-docker.pkg.dev/$PROJECT_ID/native-image-docker-repo/native-image:v1 \
  --region asia-east1 \
  --memory=1Gi \
  --allow-unauthenticated
</code></pre>
<p>Positive : 兩個版本都已成功部署到 Cloud Run！您可以在 Google Cloud Console 查看服務狀態和取得服務 URL。</p>


      </google-codelab-step>
    
      <google-codelab-step label="效能比較" duration="2">
        <h2 is-upgraded>比較指標</h2>
<p>部署完成後，您可以比較 JIT 和 Native 版本在以下方面的差異：</p>
<ul>
<li><strong>啟動時間</strong>: Native 映像檔通常啟動速度快 10-100 倍</li>
<li><strong>記憶體使用量</strong>: Native 映像檔記憶體佔用通常減少 50-80%</li>
<li><strong>映像檔大小</strong>: Native 映像檔通常更小</li>
<li><strong>冷啟動延遲</strong>: Native 版本在 Cloud Run 上的冷啟動延遲顯著降低</li>
</ul>
<h2 is-upgraded>Cloud Run 冷啟動時間對照</h2>
<h3 is-upgraded>JIT 版本冷啟動時間</h3>
<p class="image-container"><img alt="Spring JIT 冷啟動時間" src="img/ce1ff5160b826694.png"></p>
<h3 is-upgraded>Native 版本冷啟動時間</h3>
<p class="image-container"><img alt="Spring Native 冷啟動時間" src="img/cdf7e38b6699a167.png"></p>
<p>從上面兩張圖可以清楚看到，Native 版本的冷啟動時間顯著低於 JIT 版本，這對於 Cloud Run 這類 serverless 平台特別重要。</p>
<h2 is-upgraded>測試服務</h2>
<p>使用 Cloud Run 提供的 URL 測試兩個服務，觀察它們的回應時間差異。</p>
<p>Negative : 注意：Native 映像檔的建置時間會比 JIT 版本長很多，這是正常現象。權衡建置時間與執行效能是選擇使用 Native 映像檔的考量之一。</p>


      </google-codelab-step>
    
      <google-codelab-step label="總結" duration="1">
        <h2 is-upgraded>您學到了什麼</h2>
<p>恭喜！您已經完成了 Spring Native Workshop。在本實驗中，您學習了：</p>
<ul>
<li>✓ 如何配置 Spring Native 專案</li>
<li>✓ 理解 AOT 編譯和相關 Gradle 設定的用途</li>
<li>✓ 如何建置 Native 映像檔</li>
<li>✓ 如何部署應用程式到 Google Cloud Run</li>
<li>✓ JIT 與 Native 映像檔的差異</li>
</ul>
<h2 is-upgraded>後續步驟</h2>
<ul>
<li>探索更多 Spring Native 功能</li>
<li>嘗試在更複雜的應用程式中使用 Native 映像檔</li>
<li>了解 GraalVM 的其他功能</li>
</ul>
<h2 is-upgraded>參考資源</h2>
<ul>
<li><a href="https://docs.spring.io/spring-native/docs/current/reference/htmlsingle/" target="_blank">Spring Native 官方文件</a></li>
<li><a href="https://www.graalvm.org/" target="_blank">GraalVM 官網</a></li>
<li><a href="https://cloud.google.com/run/docs" target="_blank">Google Cloud Run 文件</a></li>
</ul>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/claat-public/native-shim.js"></script>
  <script src="https://storage.googleapis.com/claat-public/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/claat-public/prettify.js"></script>
  <script src="https://storage.googleapis.com/claat-public/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
